"use strict";
/**
 * Cognito Stack
 * @version 0.9.0
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CognitoStack = void 0;
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_secretsmanager_1 = require("aws-cdk-lib/aws-secretsmanager");
const constants_1 = require("./constants");
const roles_1 = require("./roles");
/// ---------------------------
/// CognitoStack Implementation
class CognitoStack extends aws_cdk_lib_1.Stack {
    constructor(scope, props) {
        super(scope, props.stackId, { env: {
                account: props.account,
                region: props.region
            } });
        this.userPool = new aws_cognito_1.UserPool(this, props.userPoolId, {
            selfSignUpEnabled: props.selfSignUpEnabled,
            signInAliases: {
                username: props.enableAliasUsername,
                email: props.enableAliasEmail
            },
            standardAttributes: {
                fullname: {
                    required: props.fullnameRequired,
                    mutable: props.fullnameMutable
                }
            },
            passwordPolicy: {
                minLength: props.passwordMinimumLength,
            },
        });
        this.userPoolClient = new aws_cognito_1.UserPoolClient(this, props.userPoolClientId, {
            userPool: this.userPool
        });
        this.userPoolIdentityProviderAmazon = new aws_cognito_1.UserPoolIdentityProviderAmazon(this, props.identityProviderId, {
            userPool: this.userPool,
            clientId: props.userPoolClientId,
            clientSecret: aws_secretsmanager_1.Secret.fromSecretAttributes(this, `${props.id}IdentityProviderSecret`, {
                secretCompleteArn: constants_1.Constants.Cognito.IdentityProviderSecretArn
            }).secretValue.toString()
        });
        const identityProviderDomain = `cognito-idp.${aws_cdk_lib_1.Stack.of(this).region}.amazonaws.com/${this.userPool.userPoolId}:${this.userPoolClient.userPoolClientId}`;
        this.identityPool = new aws_cognito_1.CfnIdentityPool(this, props.identityPoolId, {
            allowUnauthenticatedIdentities: props.allowUnauthenticatedIdentities,
            cognitoIdentityProviders: [{
                    clientId: this.userPoolClient.userPoolClientId,
                    providerName: this.userPool.userPoolProviderName
                }]
        });
        const defaultPolicy = new aws_cognito_1.CfnIdentityPoolRoleAttachment(this, `${props.id}DefaultPolicy`, {
            identityPoolId: this.identityPool.ref,
            roles: {
                authenticated: new roles_1.Roles.Cognito.AuthenticatedRole(this, constants_1.Constants.Cognito.AuthenticatedRoleId, props.resourceArns, this.identityPool.ref),
                unauthenticated: new roles_1.Roles.Cognito.UnauthenticatedRole(this, constants_1.Constants.Cognito.UnauthenticatedRoleId, props.resourceArns, this.identityPool.ref)
            }
        });
    }
}
exports.CognitoStack = CognitoStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29nbml0by1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvZ25pdG8tc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgseURBQ2tHO0FBQ2xHLDZDQUFtQztBQUduQyx1RUFBdUQ7QUFDdkQsMkNBQXVDO0FBQ3ZDLG1DQUErQjtBQXdCL0IsK0JBQStCO0FBQy9CLCtCQUErQjtBQUUvQixNQUFhLFlBQWEsU0FBUSxtQkFBSztJQU9uQyxZQUFhLEtBQWdCLEVBQUUsS0FBd0I7UUFDbkQsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUUsR0FBRyxFQUFFO2dCQUMvQixPQUFPLEVBQUssS0FBSyxDQUFDLE9BQU87Z0JBQ3pCLE1BQU0sRUFBTSxLQUFLLENBQUUsTUFBTTthQUM1QixFQUFDLENBQUMsQ0FBQztRQUVKLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxzQkFBUSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ2pELGlCQUFpQixFQUFXLEtBQUssQ0FBQyxpQkFBaUI7WUFDbkQsYUFBYSxFQUFFO2dCQUNYLFFBQVEsRUFBZ0IsS0FBSyxDQUFDLG1CQUFtQjtnQkFDakQsS0FBSyxFQUFtQixLQUFLLENBQUMsZ0JBQWdCO2FBQ2pEO1lBQ0Qsa0JBQWtCLEVBQUU7Z0JBQ2hCLFFBQVEsRUFBRTtvQkFDTixRQUFRLEVBQVksS0FBSyxDQUFDLGdCQUFnQjtvQkFDMUMsT0FBTyxFQUFhLEtBQUssQ0FBQyxlQUFlO2lCQUM1QzthQUNKO1lBQ0QsY0FBYyxFQUFFO2dCQUNaLFNBQVMsRUFBZSxLQUFLLENBQUMscUJBQXFCO2FBQ3REO1NBQ0osQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLDRCQUFjLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRTtZQUNuRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7U0FDMUIsQ0FBQyxDQUFBO1FBRUYsSUFBSSxDQUFDLDhCQUE4QixHQUFHLElBQUksNENBQThCLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxrQkFBa0IsRUFBRTtZQUNyRyxRQUFRLEVBQVEsSUFBSSxDQUFDLFFBQVE7WUFDN0IsUUFBUSxFQUFRLEtBQUssQ0FBQyxnQkFBZ0I7WUFDdEMsWUFBWSxFQUFJLDJCQUFNLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsd0JBQXdCLEVBQUU7Z0JBQ25GLGlCQUFpQixFQUFFLHFCQUFTLENBQUMsT0FBTyxDQUFDLHlCQUF5QjthQUNqRSxDQUFDLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRTtTQUM1QixDQUFDLENBQUM7UUFFSCxNQUFNLHNCQUFzQixHQUFHLGVBQWUsbUJBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxrQkFBa0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1FBRXZKLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSw2QkFBZSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsY0FBYyxFQUFFO1lBQ2hFLDhCQUE4QixFQUFFLEtBQUssQ0FBQyw4QkFBOEI7WUFDcEUsd0JBQXdCLEVBQUUsQ0FBQztvQkFDdkIsUUFBUSxFQUFRLElBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCO29CQUNwRCxZQUFZLEVBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0I7aUJBRXJELENBQUM7U0FDTixDQUFDLENBQUM7UUFFRixNQUFNLGFBQWEsR0FBRyxJQUFJLDJDQUE2QixDQUFDLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLGVBQWUsRUFBRTtZQUN0RixjQUFjLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHO1lBQ3JDLEtBQUssRUFBRTtnQkFDSCxhQUFhLEVBQU8sSUFBSSxhQUFLLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxxQkFBUyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDO2dCQUMvSSxlQUFlLEVBQUssSUFBSSxhQUFLLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxxQkFBUyxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDO2FBQ3RKO1NBQ0osQ0FBQyxDQUFDO0lBRVAsQ0FBQztDQUVKO0FBL0RELG9DQStEQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29nbml0byBTdGFja1xuICogQHZlcnNpb24gMC45LjBcbiAqL1xuXG5pbXBvcnQgeyBDZm5JZGVudGl0eVBvb2wsIENmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgICAgVXNlclBvb2wsIFVzZXJQb29sQ2xpZW50LCBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0bydcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJ1xuaW1wb3J0IHsgUm9sZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nXG5pbXBvcnQgeyBTZWNyZXQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc2VjcmV0c21hbmFnZXInXG5pbXBvcnQgeyBDb25zdGFudHMgfSBmcm9tICcuL2NvbnN0YW50cydcbmltcG9ydCB7IFJvbGVzIH0gZnJvbSAnLi9yb2xlcydcblxuLy8vIC0tLS0tLS0tLS0tLS0tLS0tXG4vLy8gQ29nbml0b1N0YWNrUHJvcHNcblxuZXhwb3J0IGludGVyZmFjZSBDb2duaXRvU3RhY2tQcm9wcyB7XG4gICAgYWNjb3VudDogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcsXG4gICAgcmVnaW9uOiAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcsIFxuICAgIGlkOiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nLFxuICAgIHN0YWNrSWQ6ICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nLFxuICAgIHVzZXJQb29sSWQ6ICAgICAgICAgICAgICAgICAgICAgc3RyaW5nLFxuICAgIGlkZW50aXR5UG9vbElkOiAgICAgICAgICAgICAgICAgc3RyaW5nLFxuICAgIGlkZW50aXR5UHJvdmlkZXJJZDogICAgICAgICAgICAgc3RyaW5nLFxuICAgIHVzZXJQb29sQ2xpZW50SWQ6ICAgICAgICAgICAgICAgc3RyaW5nLFxuICAgIHNlbGZTaWduVXBFbmFibGVkOiAgICAgICAgICAgICAgYm9vbGVhbixcbiAgICBlbmFibGVBbGlhc1VzZXJuYW1lOiAgICAgICAgICAgIGJvb2xlYW4sXG4gICAgZW5hYmxlQWxpYXNFbWFpbDogICAgICAgICAgICAgICBib29sZWFuLFxuICAgIGZ1bGxuYW1lUmVxdWlyZWQ6ICAgICAgICAgICAgICAgYm9vbGVhbixcbiAgICBmdWxsbmFtZU11dGFibGU6ICAgICAgICAgICAgICAgIGJvb2xlYW4sXG4gICAgcGFzc3dvcmRNaW5pbXVtTGVuZ3RoOiAgICAgICAgICBudW1iZXIsXG4gICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOiBib29sZWFuLFxuICAgIHJlc291cmNlQXJuczogICAgICAgICAgICAgICAgICAgc3RyaW5nW11cbn1cblxuLy8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8vIENvZ25pdG9TdGFjayBJbXBsZW1lbnRhdGlvblxuXG5leHBvcnQgY2xhc3MgQ29nbml0b1N0YWNrIGV4dGVuZHMgU3RhY2sge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSB1c2VyUG9vbDogICAgICAgICAgICAgICAgICAgICAgICAgIFVzZXJQb29sXG4gICAgcHJpdmF0ZSByZWFkb25seSBpZGVudGl0eVBvb2w6ICAgICAgICAgICAgICAgICAgICAgIENmbklkZW50aXR5UG9vbFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXNlclBvb2xDbGllbnQ6ICAgICAgICAgICAgICAgICAgICBVc2VyUG9vbENsaWVudFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uOiAgICBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b25cblxuICAgIGNvbnN0cnVjdG9yIChzY29wZTogQ29uc3RydWN0LCBwcm9wczogQ29nbml0b1N0YWNrUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIHByb3BzLnN0YWNrSWQsIHsgZW52OiB7XG4gICAgICAgICAgICBhY2NvdW50OiAgICBwcm9wcy5hY2NvdW50LFxuICAgICAgICAgICAgcmVnaW9uOiAgICAgcHJvcHMuIHJlZ2lvblxuICAgICAgICB9fSk7XG5cbiAgICAgICAgdGhpcy51c2VyUG9vbCA9IG5ldyBVc2VyUG9vbCh0aGlzLCBwcm9wcy51c2VyUG9vbElkLCB7XG4gICAgICAgICAgICBzZWxmU2lnblVwRW5hYmxlZDogICAgICAgICAgcHJvcHMuc2VsZlNpZ25VcEVuYWJsZWQsXG4gICAgICAgICAgICBzaWduSW5BbGlhc2VzOiB7XG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6ICAgICAgICAgICAgICAgcHJvcHMuZW5hYmxlQWxpYXNVc2VybmFtZSxcbiAgICAgICAgICAgICAgICBlbWFpbDogICAgICAgICAgICAgICAgICBwcm9wcy5lbmFibGVBbGlhc0VtYWlsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3RhbmRhcmRBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICAgICAgZnVsbG5hbWU6IHtcbiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWQ6ICAgICAgICAgICBwcm9wcy5mdWxsbmFtZVJlcXVpcmVkLFxuICAgICAgICAgICAgICAgICAgICBtdXRhYmxlOiAgICAgICAgICAgIHByb3BzLmZ1bGxuYW1lTXV0YWJsZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYXNzd29yZFBvbGljeToge1xuICAgICAgICAgICAgICAgIG1pbkxlbmd0aDogICAgICAgICAgICAgIHByb3BzLnBhc3N3b3JkTWluaW11bUxlbmd0aCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgdGhpcy51c2VyUG9vbENsaWVudCA9IG5ldyBVc2VyUG9vbENsaWVudCh0aGlzLCBwcm9wcy51c2VyUG9vbENsaWVudElkLCB7XG4gICAgICAgICAgICB1c2VyUG9vbDogdGhpcy51c2VyUG9vbFxuICAgICAgICB9KVxuXG4gICAgICAgIHRoaXMudXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uID0gbmV3IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFtYXpvbih0aGlzLCBwcm9wcy5pZGVudGl0eVByb3ZpZGVySWQsIHtcbiAgICAgICAgICAgIHVzZXJQb29sOiAgICAgICB0aGlzLnVzZXJQb29sLFxuICAgICAgICAgICAgY2xpZW50SWQ6ICAgICAgIHByb3BzLnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICAgICAgICBjbGllbnRTZWNyZXQ6ICAgU2VjcmV0LmZyb21TZWNyZXRBdHRyaWJ1dGVzKHRoaXMsIGAke3Byb3BzLmlkfUlkZW50aXR5UHJvdmlkZXJTZWNyZXRgLCB7XG4gICAgICAgICAgICAgICAgc2VjcmV0Q29tcGxldGVBcm46IENvbnN0YW50cy5Db2duaXRvLklkZW50aXR5UHJvdmlkZXJTZWNyZXRBcm5cbiAgICAgICAgICAgIH0pLnNlY3JldFZhbHVlLnRvU3RyaW5nKClcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgaWRlbnRpdHlQcm92aWRlckRvbWFpbiA9IGBjb2duaXRvLWlkcC4ke1N0YWNrLm9mKHRoaXMpLnJlZ2lvbn0uYW1hem9uYXdzLmNvbS8ke3RoaXMudXNlclBvb2wudXNlclBvb2xJZH06JHt0aGlzLnVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWR9YFxuXG4gICAgICAgIHRoaXMuaWRlbnRpdHlQb29sID0gbmV3IENmbklkZW50aXR5UG9vbCh0aGlzLCBwcm9wcy5pZGVudGl0eVBvb2xJZCwge1xuICAgICAgICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOiBwcm9wcy5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMsXG4gICAgICAgICAgICBjb2duaXRvSWRlbnRpdHlQcm92aWRlcnM6IFt7XG4gICAgICAgICAgICAgICAgY2xpZW50SWQ6ICAgICAgIHRoaXMudXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgICAgICAgICAgICBwcm92aWRlck5hbWU6ICAgdGhpcy51c2VyUG9vbC51c2VyUG9vbFByb3ZpZGVyTmFtZVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfV1cbiAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkZWZhdWx0UG9saWN5ID0gbmV3IENmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50KHRoaXMsIGAke3Byb3BzLmlkfURlZmF1bHRQb2xpY3lgLCB7XG4gICAgICAgICAgICBpZGVudGl0eVBvb2xJZDogdGhpcy5pZGVudGl0eVBvb2wucmVmLFxuICAgICAgICAgICAgcm9sZXM6IHtcbiAgICAgICAgICAgICAgICBhdXRoZW50aWNhdGVkOiAgICAgIG5ldyBSb2xlcy5Db2duaXRvLkF1dGhlbnRpY2F0ZWRSb2xlKHRoaXMsIENvbnN0YW50cy5Db2duaXRvLkF1dGhlbnRpY2F0ZWRSb2xlSWQsIHByb3BzLnJlc291cmNlQXJucywgdGhpcy5pZGVudGl0eVBvb2wucmVmKSxcbiAgICAgICAgICAgICAgICB1bmF1dGhlbnRpY2F0ZWQ6ICAgIG5ldyBSb2xlcy5Db2duaXRvLlVuYXV0aGVudGljYXRlZFJvbGUodGhpcywgQ29uc3RhbnRzLkNvZ25pdG8uVW5hdXRoZW50aWNhdGVkUm9sZUlkLCBwcm9wcy5yZXNvdXJjZUFybnMsIHRoaXMuaWRlbnRpdHlQb29sLnJlZilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbn1cbiJdfQ==